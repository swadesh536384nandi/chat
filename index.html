<!DOCTYPE html>
<html lang="en">
<head>
	  <meta charset="UTF-8">
	  <title>IS:Ojana Kotha</title>
	  <script src="https://cdn.tailwindcss.com"></script>
	  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.23/dist/full.min.css" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"></link>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
	<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&amp;display=swap" rel="stylesheet"/>
</head>

<!-- right click loock-->
	<script type="text/javascript" src="right_click.js" async="async"></script> 
	
<body class="bg-gray-100 h-screen flex">


  <!-- Sidebar -->
  <div id="userList" class="w-1/3 p-2 bg-white border-r overflow-y-auto">
    <div class="p-4 font-bold text-lg border-b">IS:Ojana Kotha</div>
    <!-- user items dynamically here -->
	
  </div>

  <!-- Chat Area -->
  <div class="flex-1 flex flex-col ">
    <div id="chatHeader" class="p-4 bg-white border-b flex items-center gap-3">
      <img id="chatImage" class="w-10 h-10 rounded-full" src="" alt="">
      <div id="chatName" class="font-bold"></div>
    </div>

    <div id="messages" class="flex-1 p-4 overflow-y-auto bg-gray-50"></div>

    <form id="msgForm" class="p-3 bg-white border-t flex">
      <input id="msgInput" class="flex-1 border rounded-lg px-3 py-2 focus:outline-none" placeholder="Type message...">
      <button class="ml-2 bg-green-500 text-white px-4 py-2 rounded-lg">Send</button>
    </form>
	
  </div>

  <script>
		const API = 'https://script.google.com/macros/s/AKfycbxF2oL4gtkGXtSSspFQSO2-ixsFCwrDW5o13HWehAoGktnZWNGvkykFyd3aX_USI3QyiA/exec';
		const loggedUser = JSON.parse(localStorage.getItem('user') || '{}');
		if (!loggedUser.email) window.location = 'Login.html';

		const userList = document.getElementById('userList');
		const messagesDiv = document.getElementById('messages');
		const chatName = document.getElementById('chatName');
		const chatImage = document.getElementById('chatImage');
		const msgForm = document.getElementById('msgForm');
		const msgInput = document.getElementById('msgInput');
		let currentChat = null;

		// ===== Fetch & show user list with online indicator =====
		async function loadUsers() {
		  const res = await fetch(`${API}?action=users`);
		  const data = await res.json();
		  if (data.result === 'success') {
			userList.innerHTML = `
				<h2 class="text-4xl font-bold text-center text-purple-700 p-3 border-yellow-900 border-2">Ojana Kotha</h2>
				<div class="grid grid-cols-1 lg:grid-cols-2 md:grid-cols-2 p-4  text-center border-green-600 border-b-4">
					<div class="flex flex-col items-center p-2">
						<img src="${loggedUser.image || 'https://via.placeholder.com/40'}" class="items-center w-20 h-20 rounded-full border-4 border-green-400  object-cover " alt="Profile Picture">
						<p class="text-2xl"><b>${loggedUser.name}</b></p>
						<p class="text-gray-500">${loggedUser.email}</p>
					</div>
					<div class="text-right px-5  ">
						<button onclick="logout()" class="btn bg-red-600 text-white text-2xl font-bold px-6 py-2 rounded-lg">Logout</button>
					</div>
				</div>`;
			data.users.filter(u => u.email !== loggedUser.email).forEach(u => {
			  const el = document.createElement('div');
			  el.className = "flex items-center p-3 hover:bg-gray-100 cursor-pointer";
			  const onlineDot = u.online
				? '<span class="w-3 h-3 bg-green-500 rounded-full mr-2 inline-block"></span>'
				: '<span class="w-3 h-3 bg-gray-300 rounded-full mr-2 inline-block"></span>';
			  const lastSeenText = u.online
				? 'Online'
				: (u.lastSeen ? `Last seen ${new Date(u.lastSeen).toLocaleTimeString()}` : '');
			  el.innerHTML = `
				<img src="${u.image || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full mr-3" alt="Profile Picture">
        
				<div class="flex-1 flex justify-between items-center">
					<div>
						<div class="font-medium flex items-center">${onlineDot}${u.name}</div>
						<div class="text-sm text-gray-500">${u.email}</div>
					</div>
					<div class="text-ls text-pink-500">${lastSeenText}</div>
				</div>`;
			  el.onclick = () => openChat(u);
			  userList.appendChild(el);
			});
		  }
		}

		// ===== Update my own LastSeen every 15 s =====
		async function updateLastSeen() {
		  const form = new FormData();
		  form.append('action', 'updateSeen');
		  form.append('email', loggedUser.email);
		  await fetch(API, { method: 'POST', body: form });
		}

		// ===== Existing chat functions =====
		function openChat(user) {
		  currentChat = user;
		  chatName.textContent = user.name;
		  chatImage.src = user.image || 'https://via.placeholder.com/40';
		  messagesDiv.innerHTML = '';
		  fetchMessages();
		}

		async function fetchMessages() {
		  if (!currentChat) return;
		  const url = `${API}?action=fetch&user1=${loggedUser.email}&user2=${currentChat.email}`;
		  const res = await fetch(url);
		  const data = await res.json();
		  if (data.result === 'success') {
			messagesDiv.innerHTML = '';
			data.messages.forEach(m => {
			  const isMine = m.sender === loggedUser.email;
			  const div = document.createElement('div');
			  div.className = `max-w-xs p-2 my-1 rounded-lg ${isMine ? 'bg-green-200 ml-auto' : 'bg-white'} shadow`;
			  div.textContent = m.text;
			  messagesDiv.appendChild(div);
			});
			messagesDiv.scrollTop = messagesDiv.scrollHeight;
		  }
		}
		

		msgForm.addEventListener('submit', async e => {
		  e.preventDefault();
		  if (!currentChat) return alert('Select a chat first');
		  const text = msgInput.value.trim();
		  if (!text) return;
		  const form = new FormData();
		  form.append('action', 'send');
		  form.append('SenderEmail', loggedUser.email);
		  form.append('ReceiverEmail', currentChat.email);
		  form.append('Message', text);
		  const res = await fetch(API, { method: 'POST', body: form });
		  const data = await res.json();
		  if (data.result === 'success') {
			msgInput.value = '';
			fetchMessages();
		  }
		});
		
		// // Detect typing start/stop
		let typingTimer;
		msgInput.addEventListener('input', () => {
		  clearTimeout(typingTimer);
		  updateTypingStatus(true);
		  typingTimer = setTimeout(() => updateTypingStatus(false), 1500);
		});

		async function updateTypingStatus(state) {
		  const form = new FormData();
		  form.append('action', 'typing');
		  form.append('email', loggedUser.email);
		  form.append('isTyping', state ? 'true' : 'false');
		  await fetch(API, { method: 'POST', body: form });
		}
		
		function logout() {
			localStorage.removeItem("user");
			window.location.href = "Login.html";
		}

		// ===== Polling loops =====
		setInterval(fetchMessages, 2000);
		setInterval(loadUsers, 3000);
		setInterval(updateLastSeen, 15000);

		loadUsers();
		updateLastSeen();

  </script>
</body>
</html>
